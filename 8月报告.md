**4. 子课题四---"垂直领域大模型示范研究"工作内容及进展**

1.  八月工作内容与进展（总结）

- 总体目标（承接七月）

  - 在已有混合时空-因果架构基础上，进一步增强跨尺度传递与因果-流域融合能力，并保持输入接口不变以便与已有预处理管线对接。

- 数据预处理与因果网络构建

  - 完成对细/中/粗尺度时间序列的Granger因果检测（基于已筛选的有效流域样本）；

  - 本次运行日志（关键片段）：

    - "Granger因果分析完成，用时:4636.2秒，发现432117条显著因果边"

    - "fine尺度因果网络: 346614条边"

  - 因果边数量巨大（几十万---百万级），并已将 edge_index / edge_weight
    以 torch.save 的方式保存为二进制张量（便于后续模型直接加载）。

![](media/image1.png){width="4.252004593175853in"
height="3.558911854768154in"}

- 模型架构开发（v0.1.1）

  - 在模型代码基础上实现并测试了 v0.1.1
    版本（局部单元测试通过，接口保持不变）：

    - 替换原始 GraphPooling →
      VariableAwarePooling（变量感知、保留统计特征）

    - 替换原始 GraphUnpooling → FeaturePreservingUnpooling（结合粗尺度 +
      原始细尺度并门控）

    - 替换简单 FusionLayer →
      AdaptiveFusionLayer（自适应门控融合因果/流域信息）

    - 新增 CrossScaleAttention（上采样阶段增强细尺度对粗尺度的"关注"）

![文本 AI
生成的内容可能不正确。](media/image2.png){width="3.708860454943132in"
height="0.49769685039370076in"}

![图形用户界面, 文本 AI
生成的内容可能不正确。](media/image3.png){width="4.330036089238845in"
height="3.011111111111111in"}

![文本 AI
生成的内容可能不正确。](media/image4.png){width="4.311384514435695in"
height="2.9359208223972004in"}

![](media/image5.png){width="4.390499781277341in"
height="2.6802471566054242in"}

![](media/image6.png){width="5.022374234470691in"
height="2.6833158355205597in"}

- 性能与耗时

  - 因果检测阶段（本次）总耗时 ≈ 4636s（并行化后的单次运行）；HHT
    和部分特征工程仍在过去月份已经消耗显著时间（七月记录：HHT 并行处理约
    40h）。

  - 模型 v0.1.1
    的模块级别单元测试（小样本）推理时间/内存增加有限（相较原实现），但在全尺度训练时需要进一步做内存与计算剖析。

**4. 子课题四研究进展中遇到的问题及对策**

问题 A --- NetworkX 保存失败导致预处理终止

- 报错（日志）：

  - AttributeError: module \'networkx\' has no attribute
    \'write_gpickle\'

  - 触发点：causal_analysis.py 中使用 nx.write_gpickle(G, path)

- 诊断：

  - 不同 environment/NetworkX 版本在 I/O
    辅助函数上存在差异（某些版本可能未暴露 write_gpickle，或环境中
    networkx 被部分覆盖）。

- 修正方案：使用 Python pickle 保存 NetworkX 对象（不依赖 networkx
  写函数）

问题 B --- 因果边过多、存储与后续处理瓶颈

- 现象：细尺度单层数十万条边（fine: 346,614），总显著因果边数 432,117
  --- 对模型加载、GPU 内存、消息传递效率造成压力。

- 对策（已在八月份开始试行的策略）：

  i.  稀疏化与阈值化

      - 使用统计显著性（p-value/FDR）+效应强度（Granger F-stat / coef
        magnitude）进行双阈筛选；

      - 推荐：对每个接收节点保留 top-K 入边（如 K=50 或按累计贡献 90%
        能量），显著降边数同时保留主要信号。

  ii. 结构先验约束

      - 结合空间距离和物理先验（只允许相距小于 D km
        的流域之间检测，或对远距离边施加更严格阈值）；

      - 采用变量类型约束（把生态变量与气象变量间的某些交互先天限制）。

  iii. 多尺度聚合存储

       - 生成按尺度存储的多层因果网络（fine/medium/coarse），并在模型训练时按当前尺度调用对应图；

       - 对于上采样/下采样过程，使用 coarse-level
         因果图聚合细尺度边（节省内存）。

  iv. 索引化与稀疏张量存储

      - 保存 edge_index / edge_weight 为稀疏矩阵或 CSR
        格式（scipy.sparse 或 PyTorch sparse），而不是 NetworkX
        完整对象，便于高效加载与 GPU 操作。

  v.  流水线分块加载

      - 在训练时采用按块加载（按 basin
        子集/按变量组），避免一次性将全量图加载到显存。

问题 C --- statsmodels 的 ValueWarning（协方差矩阵欠秩）

- 日志示例：

  - \"covariance of constraints does not have full rank. The number of
    constraints is 8, but rank is 7\"

- 诊断：

  - 约束矩阵或设计矩阵中存在线性相关（共线）或某些列为常数，导致协方差矩阵退化。

- 对策：

  i.  检查约束定义/约束矩阵（若是用户自定义约束，先用 QR / SVD
      检查其秩，去掉依赖约束）；

  ii. 在因果检验或回归中加入小幅正则化（ridge /
      Tikhonov），提高数值稳定性；

  iii. 如果用于显著性测试，改用稳健误差估计或使用伪逆（np.linalg.pinv）以避免崩溃提示但仍记录警告；

  iv. 对高度共线的输入变量做 PCA 或变量合并（在 HHT
      /特征工程阶段做），减少冗余。

**4. 子课题四下一步工作计划(2025.8.20-2025.9.20)**

短期（1--2 周）

- 修复并验证预处理管线 I/O 问题

  - 任务：将 causal_analysis.py 中的 nx.write_gpickle 替换为 pickle.dump
    或 json 格式输出；对保存脚本增加异常处理（如果无法 pickle，再尝试
    node_link json）。

  - 交付：能成功完成多尺度因果网络保存（fine/medium/coarse），并在日志记录每个scale保存条数。

  - 预计耗时：0.5 天（实现）+ 0.5 天（回归测试）。

- 因果边稀疏化实验（保留 top-K / FDR）

  - 任务：在构建因果网络后做阈值化策略实验（比较：p-value
    阈、FDR、per-node top-K、空间距离约束）。

  - 指标：边数、平均入/出度、保留信息量（time series reconstruction
    或简单回归重建误差）。

  - 预计耗时：1 周（包含参数扫面）。

中期（2--6 周）

- 在中等规模数据子集上做 v0.1.1 的端到端训练与性能剖析

  - 任务：用稀疏化后的因果图（按不同策略）训练模型，记录训练时间、GPU/内存占用、验证集指标（RMSE/MAE/CRPS
    等）。

  - 目标：找到平衡点（边数 vs 预测性能 vs 计算成本）。

  - 预计耗时：2--3 周（含多次实验）。

- 实现"静态因果权重的状态依赖微调"（轻量版）

  - 任务：在 CausalGraphConv 中加入小型 MLP，让 learnable_weights 接受
    node-level上下文（如局部温度/湿度均值）作为输入做条件加权（而不改变
    edge_index）。

  - 目的：增强静态结构在不同状态下的适应性，权重仍由训练控制但结构不变。

  - 预计耗时：1 周（实现+测试）。
