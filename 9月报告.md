**4. 子课题四---"垂直领域大模型示范研究"工作内容及进展**

1.  九月工作内容与进展（总结）

- 总体目标（承接八月）

  - 将数据与管线从"亚洲区域生态水文数据"迁移到"三江源/青藏高原"场景，接入
    CMFD（日尺度、多变量、0.1°）数据集，保持训练接口不变，打通"多层级流域矢量 +
    CMFD"到时空---因果模型的端到端流程。

- 数据预处理与因果网络构建

  - 新增 CMFD 专用读取与对齐

    - 实现 load_cmfd_nc_files：按"变量→年度文件"聚合，时间维在变量间
      inner 对齐，返回 \[time, lat, lon, variables\]
      四维张量；支持模糊变量名匹配与坐标正反向自动裁剪。

    - 从三层流域矢量（fine/medium/coarse）自动计算裁剪范围（total_bounds），统一重投影至
      EPSG:4326，避免投影失配与空裁剪。

  - 栅格→流域聚合

    - 使用 rasterized_grid_to_watershed
      并行栅格化（all_touched=True），在三个尺度上生成
      {scale}\_time_series.csv 与 {scale}\_valid_basin_ids.json。

  - 因果网络构建稳健化

    - build_multi_scale_causal_networks
      改为使用"实际存在的变量列表"（variables_in_ts），即从已生成的 CSV
      列名和配置 VARIABLES 求交集，避免 KeyError/缺列。

    - 产出 {scale}\_causal_edge_index.pt /
      {scale}\_causal_edge_weight.pt（二进制张量，便于训练端直接加载）。

  - 关键运行日志（示例）

    - "CMFD 合成完成: 形状 (T,Y,X,V)=... \| 变量:
      \[\'temp\',\'pres\',\'shum\',\'rhum\',\'wind\',\'srad\',\'lrad\',\'prec\',\'rain\',\'snow\'\]"

    - "fine 尺度时间序列保存: 形状=(rows, cols)，有效流域 X/Y"

    - "medium/coarse 尺度时间序列保存: ..."（三尺度均已对齐输出）

- 模型与训练管线（稳定性修复与一致性增强）

  - 训练脚本稳定化（以 train_qhu.py 为主）

    - 修复保存模型 state_dict() 调用错误 → 使用
      state_dict，且仅主进程保存与打印（当前暂以单卡运行，逻辑已兼容多卡）。

    - 验证指标路径修正：统一从 val_metrics\[\'overall\'\] 提取
      mse/mae/r2；移除重复 tqdm，loss 以 batch 平均。

    - 历史/曲线可视化健壮化：plot_training_curves 采用 overall
      指标并容错 NaN；保存前确保 OUTPUT_DIR 存在；history 中的 numpy
      标量转原生类型，避免 JSON 序列化报错。

  - 训练产物（本月）

    - OUTPUT_DIR/training_curves.png（损失与整体指标曲线）

    - OUTPUT_DIR/training_history.json（完整历史，含指标）

    - MODEL_DIR/best_model.pt（含
      data_scalers、edge_scalers、model_config）

- 并行训练（DDP）尝试与回退

  - 九月初尝试启用 DDP，遇到 "Expected to have finished reduction..."
    异常（不同 rank 对 NaN/Inf 批次的处理不一致导致上一轮归约未完成）。

  - 已形成解决方案（全局同步跳过 bad batch、训练
    drop_last=True、必要时临时启用
    find_unused_parameters=True），但为保证实验推进，本月阶段回退单卡稳定训练；并行优化留至下阶段验证。

- 性能与耗时

  - CMFD 载入与变量对齐：按"变量→年度文件"拼接，inner 对齐后堆叠为
    \[T,Y,X,V\]；在青藏区域范围内一次性加载，耗时依数据年限与 I/O
    带宽而定（单次分钟级---十余分钟级）。

  - 栅格化聚合：joblib
    并行、按时间批量处理，单尺度在分钟至十余分钟级（与流域数、网格密度、CPU
    核数相关）。

  - 因果检验：若按全量日尺度运行，复杂度与变量数×流域数平方级相关，需结合
    top-K/阈值策略控制规模（详见下节"问题与对策"）；本月以"流程打通与稳健性"为主，因果全量构建与稀疏化在下阶段统一评测。

**4. 子课题四研究进展中遇到的问题及对策**

- 问题 A --- CMFD 变量名与配置不完全一致

  - 现象：部分变量文件缺失或内部数据变量名与文件前缀不同。

  - 对策：load_cmfd_nc_files 支持模糊匹配/唯一变量兜底；因果阶段从实际
    CSV 列名提取 variables_in_ts，保证后续一致性。

- 问题 B --- 可视化失败（KeyError、保存路径不存在）

  - 现象：plot_training_curves 访问 m\[\'mse\'\]
    报错；文件夹不存在导致保存失败。

  - 对策：改用 m\[\'overall\'\]\[\'mse\'\|\'mae\'\|\'r2\'\]，对缺失项用
    NaN 占位；保存前 os.makedirs(OUTPUT_DIR, exist_ok=True)；history
    转原生类型。

- 问题 C --- 并行训练稳定性（DDP）

  - 现象：reducer 报错，根因为不同 rank 上对 NaN/Inf 的 continue
    不一致。

  - 对策：制定"全局同步 skip"方案（all_reduce 聚合 bad 标志）；训练集
    drop_last=True；短期先单卡稳定运行，DDP 调优下阶段推进。

- 问题 D --- 流域矢量字段依赖

  - 现象：process_watershed_network 依赖 HYBAS_ID/NEXT_DOWN；若换用非
    HydroBASINS 数据，可能缺列。

  - 对策：准备字段映射或基于流向的下游关系构建备选实现；本月保持
    HydroBASINS 兼容路径。

**4. 子课题四下一步工作计划(2025.9.20-2025.10.20)**

- 短期（1--2 周）

  - 因果网络全量与稀疏化

    - 在青藏区域上完成三尺度因果网络构建；引入 per-node top-K（K=50/100
      对比）、p-value/FDR + 强度阈的双阈策略，统计边数、入/出度分布。

  - 流域矢量字段适配

    - 若采用自有多层级流域数据，完成字段映射或拓扑构建，确保能生成
      {scale}\_river_edge_index/attr。

  - 数据质量增强

    - 增加异常值/极端值过滤、变量范围校验（防止极值导致训练不稳定）。

- 中期（2--4 周）

  - 端到端训练评测（稀疏化因果图）

    - 记录 RMSE/MAE/R²
      与资源开销，形成"边数---性能---计算成本"折中曲线；选择推荐 K
      与阈值。

  - 结构固定、权重状态依赖的轻量微调

    - 在 CausalGraphConv 引入条件门控（小型 MLP
      接收节点/局部上下文），不改 edge_index，仅调整权重分配，验证收益。

  - 并行可扩展性验证

    - 复启 DDP（全局同步 skip、drop_last、必要时
      find_unused_parameters=True），在 2--4
      卡上对端到端训练做可扩展性测试。

- 交付物

  - 稀疏化策略脚本与统计报表；新一轮 best_model.pt
    与曲线；因果网络版本化产物（带构建参数与日志）。
